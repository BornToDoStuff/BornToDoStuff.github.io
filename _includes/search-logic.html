
<!-- search logic -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/2.3.0/mustache.min.js"></script>
<script src="{{ site.baseurl }}/js/search-index.js"></script>
<script id="result-template" type="x-tmpl-mustache">
  {% raw %}
    <magic-item id="{{id}}">
      <a href="{{url}}"><item-name>{{title}}</item-name></a>
      <item-tagline>{{type}}, {{rarity}} {{#attunement}}(requires attunement{{#requirement}} {{requirement}}{{/requirement}}){{/attunement}}</item-tagline>
      <item-description>
        {{{content}}}
        <a href="{{url}}" class="read-more pull-right">›››</a>
      </item-description>
    </magic-item>
  {% endraw %}
</script>
<script>
  $(document).ready(function() {
    var searchbox = $('#search');
    var searchResults = $('#search-results');
    var template = $('#result-template').html();
    Mustache.parse(template);

    $("#search-btn").on("click", function(){
      if (searchbox.val() == "") { unsearch(); }
      else{ search(); }
    });
    $("#search-clear").on("click", function(){
       unsearch();
    });
    searchbox.on('keyup', function (e) {
        if (e.keyCode == 13) { search(); }
        if (searchbox.val() == "") { unsearch(); }
    });

    function search(){
      var query = searchbox.val();
      var results = search_index.search(query);
      searchResults.empty();

      if (results.length) {
        for (var item in results){
          var ref = results[item].ref;
          var result = item_cache[ref];
          loadResult(result);
        }
      }
      else {
        searchResults.html("<magic-item><item-name>There's nothing here</item-name><item-description>Looks like I haven't made this item yet, weird.</item-description></magic-item>")
      }
      //hide all normal elements and just show searched elements
      $("<style id='search-style' type='text/css'> magic-item, .pagination{display:none} #searchResults magic-item{display:block}</style>").appendTo("head")
    }

    function unsearch(){
      searchbox.val("");
      searchResults.empty();
      $("#search-style").remove();
    }

    function loadResult(result) {
      searchResults.append(Mustache.render(template, result));
    };

    var searchParams = new URLSearchParams(window.location.search);
    if (searchParams.get("q") != "")
    {
      searchbox.val(searchParams.get("q"));
      search();
    }
  });
</script>
<!-- end search logic --
