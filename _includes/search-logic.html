
<script src="{{ site.baseurl }}/js/search-index.js"></script>
<script id="result-template" type="x-tmpl-mustache">
  {% raw %}
    <magic-item>
      <a href="{{url}}"><item-name>{{title}}</item-name></a>
      <item-tags>
        <item-rarity>{{rarity}}</item-rarity>
        <item-attunement>{{#attunement}} requires attunement {{requirement}}{{/attunement}}</item-attunement>
      </item-tags>
      <item-description>
        {{{content}}}
        <a href="{{ url }}" class="read-more pull-right">›››</a>
      </item-description>
    </magic-item>
  {% endraw %}
</script>
<script>
  $(document).ready(function() {
    var searchbox = $('input#search');
    var searchResults = $('#searchResults');
    var template = $('#result-template').html();
    Mustache.parse(template);

    $("#search-btn").on("click", function(){
       search();
    });
    $("#search-clear").on("click", function(){
       unsearch();
    });
    $("#search").on('keyup', function (e) {
        if (e.keyCode == 13) { search(); }
        if ($("#search").val() == "") { unsearch(); }
    });

    function search(){
      var query = searchbox.val();
      var results = search_index.search(query);
      searchResults.empty();

      if (results.length) {
      for (var item in results){
        var ref = results[item].ref;
        var result = item_cache[ref];
        loadResult(result);
      }
    }
    else {
      searchResults.html("<magic-item><item-name>There's nothing here</item-name><item-description>Looks like I haven't made this item yet, weird.</item-description></magic-item>")
    }

      $("<style id='search-style' type='text/css'> magic-item{display:none} #searchResults magic-item{display:block}</style>").appendTo("head")
    }

    function unsearch(){
      searchbox.text("");
      searchResults.empty();
      $("#search-style").remove();
    }

    function loadResult(result) {
      searchResults.append(Mustache.render(template, result));
    };
  });
</script>
