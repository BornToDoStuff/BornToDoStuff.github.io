
<script>
  $(document).ready(function() {
    var searchbox = $('#search');
    var searchResults = $('#search-results');
    var searchform = $("#search-form");
    var searchHeader = $("#navbar-header");
    var errorMessage = "<magic-item style='margin:auto'><item-title><a>Error!</a></item-name><item-description>Ah phooie, looks like the gnomes pressed the wrong button. Please wait a moment and then try again.</item-description></magic-item>"

    if ($(window).width() <= 768) { var heights = ["","tall"]; }
  	else { var heights = ["","tall", "taller", "tallest"]; }
    var sizes = $("#grid-sizes item-description");

    function setItemHeight(ele) {
      var description = $(ele).find("item-description")[0];
      var heightCount = 0;
      while (heightCount < heights.length && description.scrollHeight > sizes[heightCount].scrollHeight + 15) {
        heightCount++;
      }

      $(ele).addClass(heights[heightCount]);
      if (description.scrollHeight > description.clientHeight)
        $(ele).addClass("show-more");
    }
    var item_cache = [];
    //const itemTemplate = ({ id, url, title, type, subtypes, rarity, attunement, requirement, content}) => `
    const itemTemplate = function(result) {
      var item = item_cache[result.ref];

      return `<magic-item id="${item.id}" class="${item.rarity.toLowerCase().replace(' ', '-')}${item.attunement ? ' attunement' : ''}${item.item_curse ? ' cursed' : ''}">
          <item-head>
            <item-title>
              <a href="${item.url}">${item.title}</a>
              <item-tagline>${item.type}, ${item.rarity.toLowerCase()} ${item.attunement ? `(requires attunement${item.requirement ? ` by ${item.requirement}`: ''})` : '' }</item-tagline>
            </item-title>
            <item-extras aria-hidden="true">
        			<div class="rarity"><img src="/images/rarities.svg" title="${item.rarity.toLowerCase()}" /></div>
        		</item-extras>
          </item-head>

          <item-description>
        		${item.content}
        	</item-description>

          <item-details>
            <div class="type">${item.type.toLowerCase()}</div>
            <div class="subtypes">${item.subtypes ? item.subtypes.join(', ').toLowerCase() : ''}</div>
            <div class="rarity">${item.rarity.toLowerCase()}</div>
            <div class="attunement">${item.attunement ? 'Yes' : ''}</div>
            <div class="curse">${item.curse ? 'Yes' : ''}</div>
          </item-details>

          <a href="${item.url}" class="read-more">
      			<div class="expander">
      				<span class="dot"></span><span class="dot"></span><span class="dot"></span>
      			</div>
      		</a>
        </magic-item>
      `;
    }


    $("#search-form").submit(function(e){
      if (searchbox.val() == "") {
        unsearch();
        e.preventDefault();
        return false;
      }
    });

    // $("#search-clear").on("click", function(){
    //    unsearch();
    // });
    // searchbox.on('keyup', function (e) {
    //     if (e.keyCode == 13) { search(); }
    //     if (searchbox.val() == "") { unsearch(); }
    // });

    function search(){
      $("body").addClass("searching");
      $('#main').hide();
      searchResults.show();
      $("section#main").infiniteScroll("destroy");

      searchbox.val(searchParams.get("q"));
      searchform.css("width", "100%");
      if ($(window).width() <= 768){  //minimize header if it is a tablet or smaller
				searchHeader.css("transform", "translateX(-350px)");
			}

      try {
        var query = searchbox.val();
        var index = lunr.Index.load(getIndex());
        var results = index.search(`${query}^20 ${query}*^5 ${query}~1`);
        searchResults.empty();

        var search_ajax;
        if (results.length) {
          search_ajax = $.get("/data/search-index.min.json", null, null, "text")
            .done(function(item_data) {
              item_cache = JSON.parse(item_data).items;
              searchResults.html(results.slice(0, 50).map(itemTemplate).join(''));
              setTimeout(function() {document.body.classList.remove('searching')}, getRandom(300,700));
            })
            .fail(function( data ) {
              console.log("error during ajax call to retrieve search index for item cache. This is the data:");
              console.log(data);

              searchResults.html(errorMessage);
              setTimeout(function() {document.body.classList.remove('searching')}, getRandom(300,700));
            })
            .always(function() {
              history.replaceState(null, "Search", "/?q=" + encodeURIComponent(query));

              var table_layout = sessionStorage.getItem("table");
              if (table_layout !== "true")
              {
                $("#search-results magic-item").each(function(){setItemHeight($(this))});
                var $searchGrid = $("section#search-results").masonry({
                  columnWidth: 'magic-item',
                  itemSelector: 'magic-item',
                  fitWidth: true,
                  horizontalOrder: true,
                  gutter: 15,
                  stagger: 0
                });
              }

              setTimeout(function() {document.body.classList.remove('searching')}, getRandom(900,1400));
            });
          }
          else {
            searchResults.html("<magic-item style='margin:auto'><item-title><a>There's nothing here</a></item-name><item-description>Looks like I haven't made this item yet, weird.</item-description></magic-item>")
            setTimeout(function() {document.body.classList.remove('searching')}, getRandom(300,700));
          }
      }
      catch(err){
        console.log(err);

        searchResults.html(errorMessage);
        setTimeout(function() {document.body.classList.remove('searching')}, getRandom(300,700));
      }
    }

    function unsearch(){
      $('#main').show();
      searchbox.val("");
      searchResults.empty();
      searchResults.hide();

      searchform.addClass("no-transition");
      searchform.css("width","0px");
      searchform[0].offsetHeight; // Trigger a reflow, flushing the CSS changes
      searchform.removeClass("no-transition");

      if ($(window).width() <= 768){  //minimize header if it is a tablet or smaller
        searchHeader.addClass("no-transition");
        searchHeader.css("transform", "translateX(0px)");
        searchHeader[0].offsetHeight; // Trigger a reflow, flushing the CSS changes
        searchHeader.removeClass("no-transition");
      }

      setupScroll($('section#main'), $('section#main').data('masonry'));
    }

    var searchParams = new URLSearchParams(window.location.search);
    if (searchParams.get("q") && searchParams.get("q") !== null)
    {


      search();
    }

  });

  function getRandom(min, max) {
    return Math.floor(Math.random() * (max - min + 1) ) + min;
  }

  async function getDocument(endpoint, key){
    let data = sessionStorage.getItem(key);     // First check if there's data in SessionStorage
    if(data){
      return JSON.parse(data);       // If there's something in the sessionStorage with our key, return it
    }
    data = await fetch(endpoint).then(r => r.json()); //If there's nothing in the storage, make the AJAX request
    sessionStorage.setItem(key, JSON.stringify(data));     //Then save it into the storage to avoid more requests later on

    return data;
  }

  function getIndex(){
    const endpoint = "/data/search-index.min.json";
    const key = "search-index";

    let index = sessionStorage.getItem(key);
    if(index){ return JSON.parse(index); }

    var ajaxRequest = $.get(endpoint, null, null, "text")
      .done(function( item_data ) {
        index = lunr(function () {
          this.ref('ord');
          this.field('title', { boost: 10 });
          this.field("type", { boost: 2 });
          this.field("subtypes");
          this.field("classes");
          this.field("damage");
          this.field("tags", { boost: 5 });
          this.field("searchtext");

          JSON.parse(item_data).items.forEach(function (doc) {
            this.add(doc);
          }, this);
        });

        sessionStorage.setItem(key, JSON.stringify(index));
        return index;
      })
      .fail(function( data ) {
        console.log("error during ajax call to retrieve search index. This is the data:");
        console.log(data);

        searchResults.html(errorMessage);
        setTimeout(function() {document.body.classList.remove('searching')}, getRandom(300,700));
      });
  }
</script>

<script>

</script>
<!-- end search logic -->
